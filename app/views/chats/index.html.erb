<%= stylesheet_link_tag "chats", :media => "all" %>



<style type="text/css">



    img:hover {
         cursor: pointer;
     }
     input[type=file] {
         display: none;
     }


     #image{
          height: 45px;
    border-radius: 10px;
    padding: 5px;
    margin: 10px 0px;
    outline: none !important;
    box-shadow: 0px 0px 4px 0px #e2e2e2;
    -webkit-transition: box-shadow .3s;
    transition: box-shadow .3s;
     }



 #image:hover{
  box-shadow: 0 0 11px rgba(33,33,33,.2);
}


     #video{
          height: 45px;
    border-radius: 10px;
    padding: 5px;
    margin: 10px 0px;
    outline: none !important;
    box-shadow: 0px 0px 4px 0px #e2e2e2;
    -webkit-transition: box-shadow .3s;
    transition: box-shadow .3s;
     }



 #video:hover{
  box-shadow: 0 0 11px rgba(33,33,33,.2);
}




     #doc{
          height: 45px;
    border-radius: 10px;
    padding: 5px;
    margin: 10px 0px;
    outline: none !important;
    box-shadow: 0px 0px 4px 0px #e2e2e2;
    -webkit-transition: box-shadow .3s;
    transition: box-shadow .3s;
     }



 #doc:hover{
  box-shadow: 0 0 11px rgba(33,33,33,.2);
}

</style>











<div class="chat__main--wrapper">
  <input type="hidden" class="input__active--user" name="active_user" value="-1">
  <input type="hidden" class="input__current--user" name="current_user" value="<%= current_user.id %>">
  
  <div class="chat__main--sub-section chat__contact--panel ">

    <div class="contactMargin">
      <%= render @users %>
      <div class="proximyLogo">
        

          <%= image_tag("proximy-top.jpg", class: "logoMain") %>

      </div>
    </div>

  </div>













<div class="chat__main--sub-section chat__message--panel">



    <div id="messages">
      
    </div>



          <div class="messageField">
              <form class="form__message-new" action="#">
                  <div class="uploadItems">


   

                          <div class="col_4">
                            <div class="form-group">
                              <label for="doc">
                                <input class="form__input-attachment-doc" id="doc" type="file" accept=".xls,.xlsx,.pdf,.docx">
                                <img src='<%= asset_path 'addDoc.png' %>' id="doc">
                              </label>
                            </div>
                          </div>


                          <div class="col_4">
                            <div class="form-group">
                              <label for="video">
                                <input class="form__input-attachment-video" id="video" type="file" accept=".mp4,.avi,.mpg">
                                <img src='<%= asset_path 'addVideo.png' %>' id="video">
                              </label>
                            </div>
                          </div>


                         
                          <div class="col_4">
                            <div class="form-group">
                              <label for="image">
                                <input class="form__input-attachment-image" id="image" type="file" accept=".png,.jpg,.gif">
                                <img src='<%= asset_path 'addImage.png' %>' id="image">
                              </label>
                            </div>
                          </div>



 



                            

  



                </div> 



              <div class="messageForm">

                <div class="form-group">

                  <textarea class="form-control form__input-body" placeholder="Type message here..."  oninput="auto_grow(this)" style="height: 45px;" data-emojiable="true"></textarea>
                </div>
              </div>
             

          <div class="sendButton">
             <%= image_submit_tag "sendMessage.png", class: "iconImageMessage" %>
  

              </div>
                          
                     
                      





              </form>

        </div>




  </div>
</div>


<script type="text/javascript">
  function auto_grow(element) {
    element.style.height = "48px";
    element.style.height = (element.scrollHeight)+"px";
}
$('#messages').animate({scrollTop: document.body.scrollHeight},"fast");
</script>


<script type="text/javascript">
  $(document).ready(() => {
    const $messages = $('#messages')
    const $contactElement = $('.chat__contact--element')
    const $inputActiveUser = $('.input__active--user')
    const $inputCurrentUser = $('.input__current--user')
    const $newFriendRequestManage = $('.form__friend--request-manage')
    const $btnFriendRequestAccept = $('.btn__friend--request-accept')
    const $btnFriendRequestDeny = $('.btn__friend--request-deny')
    
    const $document = $(document)
    const $window = $(window)
    const itemsToShow = 5
    
    $window.on('scroll', () => {
      if ($document.height() - $window.height() - $(this).scrollTop() == -100) {
        $(`.message:hidden:lt(${itemsToShow})`).show()
      }
    })
    
    $('.chat__contact--element').on('click', (e) => {
      const $htmlBody = $('html, body')
      const $selectedContactElement = $(e.currentTarget)
      const selectedUserId = $selectedContactElement.data('id')
      const isFriendRequest = $selectedContactElement.data('is-friend-request')
      
      if ($selectedContactElement.hasClass('unknown') && !$selectedContactElement.hasClass('is-friend-request')) {
        alert("This user is not in your friends list yet, you can't send message to him now.")
        return
      }
      
      $contactElement.removeClass('is-active')
      $contactElement.removeClass('is-new-message')
      
      if (isFriendRequest == 1) {
        $newFriendRequestManage.removeClass('hidden')
      }
      
      $htmlBody.animate({ scrollTop: $(document).height() }, "slow")
      
      $.ajax({
        type: "GET", 
        url: "/chats/list_messages/" + selectedUserId,
        data: {},
        success: (data, textStatus, jqXHR) => {
          $messages.html(data)
          
          $('.message').filter(function(index) {
              return (($(this).offset().top) > $window.height())
          }).hide()
        },
        error: (jqXHR, textStatus, errorThrown) => {}
      })

      $selectedContactElement.addClass('is-active')
      $inputActiveUser.val(selectedUserId)
    })
  })
</script>






